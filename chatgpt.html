<!DOCTYPE html>
<html lang="kn">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ಪೋಸ್ಟ್ ಸೃಷ್ಟಿಸಿ ಮತ್ತು ವೀಕ್ಷಿಸಿ</title>
<style>
body { font-family: Arial; background:#f1f4f9; padding:20px; }
.container { max-width:600px; margin:auto; background:#fff; padding:20px; border-radius:10px; box-shadow:0 3px 15px rgba(0,0,0,0.1); }
h2 { text-align:center; }
input, textarea, select, button { width:100%; margin:8px 0; padding:10px; border-radius:6px; border:1px solid #ccc; }
button { background:#2563eb; color:white; border:none; cursor:pointer; font-weight:bold; }
.message { margin:10px 0; font-weight:bold; }
.message.success { color:green; }
.message.error { color:red; }
.post { background:#f9f9f9; padding:15px; border-radius:8px; margin-bottom:15px; box-shadow:0 1px 8px rgba(0,0,0,0.1); }
.post img { width:100%; border-radius:6px; margin-top:8px; }
.post .meta { color:#666; font-size:13px; margin-bottom:5px; }
</style>
</head>
<body>

<div class="container">
  <h2>ಪೋಸ್ಟ್ ಸೃಷ್ಟಿಸಿ</h2>

  <div id="message" class="message"></div>

  <input type="text" id="title" placeholder="ಶೀರ್ಷಿಕೆ ನಮೂದಿಸಿ">
  <textarea id="content" rows="4" placeholder="ವಿಷಯ ನಮೂದಿಸಿ"></textarea>
  <input type="file" id="image" accept="image/*">

  <select id="state" onchange="updateDistricts()">
    <option value="">ರಾಜ್ಯ ಆಯ್ಕೆಮಾಡಿ</option>
    <option value="ಕರ್ನಾಟಕ">ಕರ್ನಾಟಕ</option>
  </select>

  <select id="district" onchange="updateTaluks()">
    <option value="">ಜಿಲ್ಲೆ ಆಯ್ಕೆಮಾಡಿ</option>
  </select>

  <select id="taluk">
    <option value="">ತಾಲೂಕು ಆಯ್ಕೆಮಾಡಿ(Optional)</option>
  </select>

  <button onclick="createPost()">ಪೋಸ್ಟ್ ಸಲ್ಲಿಸಿ</button>

  <hr>

  <h2>ಎಲ್ಲಾ ಪೋಸ್ಟ್‌ಗಳು</h2>
  <div id="posts"></div>
</div>

<script>
const API_URL = 'https://newsbuzz-1.onrender.com';

const locationData = {
  'ಕರ್ನಾಟಕ': {
    'ಮೈಸೂರು': ['ಮೈಸೂರು ನಗರ','ನಂಜನಗೂಡು','ಟಿ.ನರಸಿಪುರ'],
    'ಧಾರವಾಡ': ['ಧಾರವಾಡ','ನವಲಗುಂದ','ಕಲಘಟಗಿ']
  }
};

function updateDistricts() {
  const state = document.getElementById('state').value;
  const districtSelect = document.getElementById('district');
  const talukSelect = document.getElementById('taluk');
  districtSelect.innerHTML = '<option value="">ಜಿಲ್ಲೆ ಆಯ್ಕೆಮಾಡಿ</option>';
  talukSelect.innerHTML = '<option value="">ತಾಲೂಕು ಆಯ್ಕೆಮಾಡಿ</option>';
  if(locationData[state]) {
    Object.keys(locationData[state]).forEach(d => {
      const opt = document.createElement('option'); opt.value=d; opt.textContent=d;
      districtSelect.appendChild(opt);
    });
  }
}

function updateTaluks() {
  const state = document.getElementById('state').value;
  const district = document.getElementById('district').value;
  const talukSelect = document.getElementById('taluk');
  talukSelect.innerHTML = '<option value="">ತಾಲೂಕು ಆಯ್ಕೆಮಾಡಿ</option>';
  if(locationData[state] && locationData[state][district]) {
    locationData[state][district].forEach(t => {
      const opt = document.createElement('option'); opt.value=t; opt.textContent=t;
      talukSelect.appendChild(opt);
    });
  }
}

function showMessage(msg, type) {
  const div = document.getElementById('message');
  div.textContent = msg;
  div.className = `message ${type}`;
  setTimeout(()=>div.textContent='',4000);
}

async function createPost() {
  const title = document.getElementById('title').value.trim();
  const content = document.getElementById('content').value.trim();
  const state = document.getElementById('state').value.trim();
  const district = document.getElementById('district').value.trim();
  const taluk = document.getElementById('taluk').value.trim();
  const imageFile = document.getElementById('image').files[0];

  if(!title||!content||!state||!district){
    showMessage("ಎಲ್ಲಾ ಅಗತ್ಯ ಮಾಹಿತಿಯನ್ನು ನಮೂದಿಸಿ.", "error"); return;
  }

  const formData = new FormData();
  formData.append('title', title);
  formData.append('content', content);
  formData.append('state', state);
  formData.append('district', district);
  if(taluk) formData.append('taluk', taluk);
  if(imageFile) formData.append('image', imageFile);

  // Add user profile if exists in localStorage
  const profile = JSON.parse(localStorage.getItem('userProfile'));
  if(profile){
    formData.append('username', profile.username);
    formData.append('profilePic', profile.profilePic);
    formData.append('userId', profile.userId);
  }

  try{
    const res = await fetch(`${API_URL}/posts`, {method:'POST', body:formData});
    const post = await res.json();
    if(res.ok){
      showMessage("ಪೋಸ್ಟ್ ಯಶಸ್ವಿಯಾಗಿ ರಚಿಸಲಾಗಿದೆ ✔","success");
      document.getElementById('title').value='';
      document.getElementById('content').value='';
      document.getElementById('state').value='';
      document.getElementById('district').innerHTML='<option value="">ಜಿಲ್ಲೆ ಆಯ್ಕೆಮಾಡಿ</option>';
      document.getElementById('taluk').innerHTML='<option value="">ತಾಲೂಕು ಆಯ್ಕೆಮಾಡಿ</option>';
      document.getElementById('image').value='';
      addPostToPage(post); // Show immediately
    }else{
      showMessage(post.message||"ಪೋಸ್ಟ್ ರಚಿಸುವಲ್ಲಿ ದೋಷ.","error");
    }
  }catch(err){
    showMessage("ಸರ್ವರ್ ಸಂಪರ್ಕ ದೋಷ.","error");
  }
}

// Load existing posts
async function loadPosts(){
  const container = document.getElementById('posts');
  container.innerHTML = '';
  try{
    const res = await fetch(`${API_URL}/posts`);
    const posts = await res.json();
    posts.forEach(addPostToPage);
  }catch(err){
    container.innerHTML='<p>ಪೋಸ್ಟ್‌ಗಳನ್ನು ಲೋಡ್ ಮಾಡಲು ದೋಷ.</p>';
  }
}

// Add single post to page
function addPostToPage(post){
  const container = document.getElementById('posts');
  const div = document.createElement('div');
  div.className='post';
  div.innerHTML=`
    <div class="title">${post.title}</div>
    <div class="meta">${post.username || 'ಅಜ್ಞಾನ'} | ${post.state}, ${post.district} ${post.taluk||''}</div>
    <p>${post.content}</p>
    ${post.imageUrl? `<img src="${post.imageUrl}"/>`:''}
  `;
  container.prepend(div); // show newest first
}

loadPosts();
</script>

</body>
</html>
